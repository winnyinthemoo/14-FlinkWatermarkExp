# README

# **研究目的**

探究Flink水位线延迟时间对窗口触发与结果准确性的影响。

# **研究内容**

深入理解Flink的水位线（Watermark）机制，探究水位线延迟时间对窗口触发延迟和结果计算准确度的影响。进一步研究在乱序数据场景下，如何通过合理设置水位线延迟时间，在延迟与计算准确性之间取得平衡。

# **实验**

## **实验环境**

### 硬件环境

本实验采用物理机搭建 Flink Standalone 分布式集群，集群由 **4 个节点** 组成（1 个 Master 节点兼做计算，3 个 Worker 节点），各节点均处于同一局域网（ECNU-1X 校园网）环境下 1。具体配置如下表所示：

| **节点角色** | **节点名称** | **CPU 核数** | **内存大小 (Physical)** | **存储类型** | **网络带宽** | **Slots数量** |
| --- | --- | --- | --- | --- | --- | --- |
| **Master & Worker0** | JobManager | 24 vCores | 32 GB | SSD | 校园网 (WLAN/LAN) | 1 |
| **Worker 1** | Slave1 | 8 vCores | 16 GB | SSD | 校园网 (WLAN/LAN) | 1 |
| **Worker 2** | Slave2 | 20 vCores | 32 GB | SSD | 校园网 (WLAN/LAN) | 1 |
| **Worker 3** | Slave3 | 8 vCores | 16 GB | SSD | 校园网 (WLAN/LAN) | 1 |

### 软件环境

集群统一运行在 Windows 操作系统上 ，已配置 Java 环境变量并统一部署了 Apache Flink。具体版本信息如下：

- **操作系统**：Windows 10 / 11 (64-bit)
- **JDK 版本**：Java SE Runtime Environment 1.8.0_202 (build 25.202-608)
- **Flink 版本**：Apache Flink 1.9.3 (Scala 2.12)
- **集群模式**：Flink Standalone Cluster

## **实验负载**

本实验旨在探究 Flink 水位线（Watermark）机制在不同延迟设置下对窗口触发与结果准确性的影响。为了构建具有代表性的流处理场景，我们参考了 Apache Flink 官方训练项目中的“每小时小费统计”（Hourly Tips）案例，并结合真实的 NYC 出租车数据集进行了适配与扩展。以下为详细的实验数据集与工作负载定义。

### 数据集

本实验选用 **NYC Yellow Taxi Trip Records (2024)** 作为输入数据流。数据集的选择基于以下考量：

- **数据特征**：该数据集包含高精度的行程记录，核心字段包括行程开始时间（Trip Start Timestamp）、行程结束时间、乘客支付的小费金额（Tip Amount）、总金额（Total Amount）以及车行 ID（Vendor ID）。
- **数据优势**：与芝加哥出租车数据集相比，NYC 数据集的时间戳粒度更细（非 15 分钟聚合），且数据在采集和上传过程中存在天然的乱序（Out-of-Order）特性，为研究 EventTime 语义下的水位线延迟处理提供了理想的实验环境。
- **隐私保护与适配**：原始 Flink Training 的 HourlyTips 任务旨在计算“每小时赚取小费最多的**司机**”。然而，由于真实的 NYC 公开数据集出于隐私保护移除了具体的“司机 ID (Driver ID)”，仅保留了“车行 ID (Vendor ID)”。因此，本实验对任务逻辑进行了适配，将聚合维度从“司机”调整为“车行”，即统计“每小时各出租车车行的小费总额”。这一调整保留了 KeyBy 分组聚合的核心计算逻辑，不影响对水位线机制的验证。

### 工作负载

实验的工作负载是一个典型的基于事件时间（EventTime）的流式窗口聚合任务。该负载衍生自 Flink 官方提供的 `HourlyTips` 练习题，其实际代码逻辑参考了官方解决方案并进行了相应的修改。

***核心计算逻辑***

任务的数据流处理路径如下：

1. **Source**：读取包含乱序时间戳的出租车行程数据流。
2. **Watermark Strategy**：分配时间戳并生成水位线，也是本实验的核心控制变量。
3. **KeyBy**：根据 `Vendor ID` 对数据流进行分区，确保同一车行的数据进入同一并行度。
4. **Window**：应用基于事件时间的窗口分配器。
5. **Aggregation**：在窗口内对 `Tip Amount` 字段进行求和统计。这与参考代码中通过 `process` 函数计算小费总和的逻辑一致。

***窗口分配策略对比***

为了更全面地评估水位线在不同负载模式下的表现，我们在同一聚合任务下设计了两种不同的窗口分配策略进行对比测试：

- **滚动窗口 (Tumbling Window)**：
    - **定义**：使用 `TumblingEventTimeWindows.of(Time.hours(1))`。
    - **逻辑**：将数据流划分为互不重叠的 1 小时固定时间段（例如 12:00-13:00, 13:00-14:00）。
    - **目的**：测试在标准批次处理场景下，水位线延迟对单一窗口闭合时机及数据丢弃率的影响。
- **滑动窗口 (Sliding Window)**：
    - **定义**：窗口大小为 1 小时，滑动步长为 30 分钟（Size=1h, Slide=30min）。
    - **逻辑**：窗口之间存在重叠，每隔 30 分钟触发一次对过去 1 小时数据的统计。
    - **目的**：引入重叠窗口增加了触发计算的频率。此场景旨在探究当一条迟到数据同时归属于多个窗口时，不同的水位线设置如何影响相邻窗口的触发延迟与结果一致性。

## **实验步骤**

本实验在搭建好的 Flink Standalone 分布式集群上进行。

### 1. 基础环境配置与集群搭建

在启动集群前，需统一各节点的软件环境并修改关键配置文件，以构建 Flink Standalone 分布式集群。

- **基础软件安装**：
    - **Java 环境**：在所有节点（Master 及 Slaves）上安装 Java 8 (JDK 1.8.0) ，配置环境变量，确保在终端输入 `java -version` 能正确输出版本信息，配置结果如下图所示。
        
        ![image.png](/pic/image.png)
        
    - **Flink 安装**：统一下载 Apache Flink 1.9.3 (Scala 2.12) 版本，在解压后的文件夹下运行终端命令`.\bin\start-cluster.bat`，结果如下图所示，并能通过`http://localhost:8081/`访问Dashboard，即可成功配置单机版Flink。
        
        ![image.png](/pic/image%201.png)
        
- **网络与配置文件修改**：
    - **网络环境**：确保所有节点连接至同一局域网（本次实验使用 ECNU-1X 校园网），保证节点间能通过 IP 互通 。
    - **节点配置**：一台Master节点和三台Slave节点都将 `conf/flink-conf.yaml` 文件中的`jobmanager.rpc.address` 属性设置为 Master 节点的公网IP地址（例如 `172.25.xxx.xxx`），指定其为集群的主节点 。
    - **Master节点配置**：将其他成员的公网IP填入到`flink-1.9.3\conf\slave`

### 2. 分布式集群启动与验证

配置完成后，启动集群进程并验证节点拓扑。

- **启动指令**：
    - 所有节点在flink文件夹下打开终端并运行命令 `.\bin\start-cluster.bat` 。
- **集群拓扑验证**：
    - 访问 Master 节点的网页Dashboard（`http://<Master-IP>:8081`）。
    - 检查 **Task Managers** 数量是否对应实际节点数（本次实验应显示4个 TaskManager），并确认 **Total Task Slots** 总数符合预期 。部署结果如下图所示。

![cluster.png](/pic/cluster.png)

### 3. 数据集分发与准备

由于实验采用本地文件读取模式，在分布式环境下，必须保证所有 Worker 节点在相同路径下拥有完整的数据集文件。将预处理后的 NYC 出租车数据集（Parquet 格式）分发至集群中每一台机器的固定目录，并确保文件权限正确且大小一致。

同时，编写Java程序并打包成Jar包，存放在Master节点的电脑中。

### 4. 作业提交与多参数对照实验

本步骤为实验的核心环节。我们使用编写好的 Java 程序 ，通过改变命令行参数来调整水位线时间。

实验分为两组负载进行：

1. **滚动窗口组**：每小时统计一次。
2. **滑动窗口组**：窗口大小 1 小时，滑动步长 30 分钟。

针对每组负载，分别设置水位线参数为 `0, 5, 10, 15, 23, 25, 30, 60` 分钟，重复执行以下步骤：

- 使用 `flink run` 命令提交作业。在Master节点的flink文件夹下的终端中运行命令
`./bin/flink run -c com.hazel.watermark.MaxTipsJob D:\FlinkWatermarkExp-1.0-SNAPSHOT.jar 0` ，其中“0”为水位线参数。
- 作业提交后，在网页dashboard中 "Running Jobs" 页面观察作业状态，点击进入作业详情页，查看算子拓扑图（Source -> Map -> Window -> Sink）等其他信息。

实验过程如下。

**作业提交成功的终端界面：**

![image.png](/pic/image%202.png)

**网页dashboard中正在运行的作业页面：**

![image.png](/pic/image%203.png)

![image.png](/pic/image%204.png)

**查看作业运行时TaskManagers状态：**

![image.png](/pic/image%205.png)

**查看作业运行时Watermark参数：**

![image.png](/pic/image%206.png)

### 5. 结果收集与统计分析

待作业运行完毕处理完所有数据后，Sink 算子将结果输出至指定的本地文本文件`window_result_0.txt`或者`slide_window_result_0.txt`，分别代表滚动窗口下水位线设置为0的结果和滑动窗口下水位线设置为0的结果。具体如下图所示。

![image.png](/pic/image%207.png)

- **数据处理：**
    - 查看输出，确认包含窗口起始时间、车行ID、小费总额及系统延迟等字段。如下图所示。
    
    ![image.png](/pic/image%208.png)
    
    - 运行 Python 分析脚本 `result_compare_parquet.py`，读取该结果文件与 Ground Truth 进行比对，计算丢失率（Loss Rate）、全局误差（Global Error）及平均延迟（Average Delay）。输出示例如下所示。
    
    ```python
    Ground truth: 289 keys loaded
    Flink results: 287 keys loaded
    Average delay: 30.63751472320377 min over 283 records
    ======================================
    Total keys (window,taxi): 289
    ------ Global Metrics ------
    True total tip:  2006207.48
    Flink total tip: 1191088.00
    Global error:    40.6299%
    ------ Per-Record Metrics ------
    MAE:  2820.482630
    MAPE: 35.4917%
    ------ Fit Metric ------
    R^2 score: 0.426799
    ```
    

## **实验结果与分析**

滚动窗口实验结果：

| 水位线  $W$  (min) | 0 | 5 | 10 | 15 | 23 | 25 | 30 | 60 |
| --- | --- | --- | --- | --- | --- | --- | --- | --- |
| 平均延迟(min) | 10.5583 | 40.1512 | 48.3484 | 47.7260 | 49.1255 | 49.1286 | 50.5104 | 68.4321 |
| 丢失率 | 79.51% | 19.41% | 1.86% | 1.85% | 1.83% | 0.63% | 0.62% | 0.53% |
| 全局误差 | 82.06% | 27.73% | 11.01% | 11.00% | 10.98% | 9.89% | 9.88% | 9.79% |
| MAE | 5716.4079 | 1931.4704 | 766.7204 | 766.0885 | 765.0607 | 689.012 | 688.3038 | 681.6926 |
| MAPE | 63.81% | 21.47% | 10.78% | 10.75% | 10.73% | 10.58% | 9.98% | 9.88% |
| R^2 | -0.8225 | 0.5433 | 0.9550 | 0.9554 | 0.9558 | 0.9678 | 0.9769 | 0.9773 |

滑动窗口实验结果：

| 水位线  $W$  (min) | 0 | 5 | 10 | 15 | 23 | 25 | 30 | 60 |
| --- | --- | --- | --- | --- | --- | --- | --- | --- |
| 平均延迟(min) | 15.6922 | 30.6375 | 35.8143 | 36.1130 | 38.0613 | 38.5416 | 45.8925 | 75.5524 |
| 丢失率 | 40.69% | 10.03% | 1.26% | 1.25% | 1.28% | 0.62% | 0.53% | 0.04% |
| 全局误差 | 68.66% | 40.63% | 32.44% | 32.24% | 32.93% | 31.70% | 28.13% | 9.55% |
| MAE | 4766.3996 | 2820.4826 | 2251.6556 | 2238.3477 | 2285.8701 | 2200.7006 | 1952.6210 | 663.1574 |
| MAPE | 57.66% | 35.49% | 30.63% | 30.11% | 32.96% | 29.96% | 23.64% | 9.73% |
| R^2 | -0.2705 | 0.4268 | 0.6310 | 0.6327 | 0.6274 | 0.6442 | 0.7028 | 0.9786 |

注：以下分析用  $W$  代表水位线参数Watermark，默认单位为分钟(min)。

### 一、实验衡量指标定义

为了全面评估 Flink 水位线机制在“实时性”与“准确性”之间的权衡关系，本实验选取了以下三个核心指标对实验结果进行量化评估。

***1.1 数据完整性指标：丢失率 (Data Loss Rate)***

- **定义与计算**：丢失率衡量了因水位线设置过短，导致无法进入对应窗口并被系统丢弃的数据比例。计算公式如下：

$$
Loss Rate = \frac{N_{dropped}}{N_{total}} \times 100\%
$$

- 其中， $N_{dropped}$ 为被判定为迟到并丢弃的数据条数， $N_{total}$ 为数据集总条数（本实验为 300,000 条）。这是评估水位线机制最直观的指标。它直接反映了系统对乱序数据的“容忍度”。丢失率越低，说明水位线挽回的迟到数据越多，数据的完整性越高。

***1.2 实时性指标：平均系统延迟 (Average System Latency)***

- **定义与计算**：平均系统延迟衡量了窗口从“理论结束时间”到“实际输出结果”之间的时间差。它代表了用户为了等待迟到数据而付出的时间成本。计算公式如下：

$$
D_{avg} = \frac{1}{M} \sum_{i=1}^{M} (T_{output}^{(i)} - T_{windowend}^{(i)})
$$

- 其中， $T_{output}$ 为 Flink 算子在处理该窗口时的水位线时间加上水位线延迟时间，代表处理该窗口时收到的最大事件时间， $T_{windowend}$ 为该窗口的理论结束时间（事件时间）， $M$ 为触发的窗口总数。水位线的本质是“以延迟换准确”。该指标量化了为了提升准确性，系统必须额外引入多少等待时间。这是评估流处理系统实时性能的关键指标。

***1.3 业务准确性指标：全局误差 (Global Error)***

- **定义与计算：** 全局误差衡量了 Flink 计算出的聚合结果（小费总额）与基于全量数据的真实结果（Ground Truth）之间的偏差程度。 计算公式如下：

$$
E_{global} = \frac{|S_{Flink} - S_{Truth}|}{S_{Truth}} \times 100\%
$$

- 其中， $S_{Flink}$ 为 Flink 任务输出的所有窗口小费总和， $S_{Truth}$ 为使用 Pandas 对全量数据进行离线计算得到的真实总和。丢失率仅反映数据“条数”的缺失，而全局误差反映了“业务价值”的偏差。在金融统计场景下（如本实验的小费统计），金额的准确性比丢失率更能够代表最终数据的正确性。

### 二、水位线对窗口延迟和数据完整性（丢失率）的影响

本节分别选取**滚动窗口**与**滑动窗口**的实验数据，旨在探究水位线参数的变化对窗口延迟率和数据完整性（丢失率）的一般性影响规律。

![tumbling_window_analysis.png](/pic/tumbling_window_analysis.png)

***图 2-1：滚动窗口的水位线延迟对数据完整性与实时性的权衡分析***。横轴为水位线延迟 (min)；左侧纵轴（蓝色柱状）表示数据丢失率 (%)，反映数据完整性；右侧纵轴（红色折线）表示平均系统延迟 (min)，反映系统实时性。图表展示了滚动窗口与滑动窗口下一致的性能趋势。

![sliding_window_analysis.png](/pic/sliding_window_analysis.png)

***图 2-2：滑动窗口的水位线延迟对数据完整性与实时性的权衡分析***。横轴为水位线延迟 (min)；左侧纵轴（蓝色柱状）表示数据丢失率 (%)，反映数据完整性；右侧纵轴（红色折线）表示平均系统延迟 (min)，反映系统实时性。图表展示了滚动窗口与滑动窗口下一致的性能趋势。

***2.1 现象描述***

观察 **滚动窗口（Tumbling Window）与滑动窗口（Sliding Window）**，我们发现两张图表呈现出高度一致的 **“剪刀差”趋势** ：

- **蓝色柱状图 (丢失率)**：随水位线增加呈指数级下降，随后迅速趋于平缓。
- **红色折线图 (延迟)**：随水位线增加呈分段线性上升。

***2.2 阶段性特征分析***

基于实验数据表，我们将这一共同走势划分为三个特征鲜明的阶段：

- **阶段一：高收益区 (**  $W$  = **0 → 10 min)**
    - **数据**：
        - 在**滚动窗口**中，水位线从 0 增至 10 分钟，数据丢失率从 **79.51%** 骤降至 **1.86%**，挽回了近 78% 的数据。同时，窗口延迟也随之线性上升。
        - 在**滑动窗口**中，表现出同样的趋势，丢失率从 **40.69%** 迅速收敛至 **1.26%**。同时，窗口延迟也随之线性上升。
    - **趋势特征**：这是曲线变化最剧烈的区间。水位线的微小增加带来了准确性的较大提升和窗口延迟的较大增大。
    - 分析：这证实了水位线机制在处理“短时乱序”数据时的高效性。绝大多数滞后到达的数据都都可以在10分钟内被捕获，因此覆盖这一区间的收益极高。
- **阶段二：平台低效区 (**  $W$  = **10 → 30 min)**
    - **数据**：
        - **滚动窗口**：水位线从 10 增至 23 分钟，丢失率仅从 **1.86%** 降至 **1.83%**，几乎停滞，同时窗口延迟也几乎并未增加。
        - **滑动窗口**：同样呈现平台特征，从   $W$  =10 到   $W$  =15，丢失率维持在 **1.2%** 左右，同时窗口延迟也维持在30-40min。
    - **趋势特征**：进入此区间后，蓝色柱子高度几乎不再变化，表明增加延迟不再带来明显的准确性收益，系统进入“空转”状态。
    - 分析：这揭示了数据分布中可能存在的“断层区”。在此期间增加水位线，无法显著减少数据丢失率，但同时也几乎不增加窗口延迟代价。
- **阶段三：长尾代价区 (**  $W$  = **30 →60 min)**
    - **数据**：
        - **滚动窗口**：为了将丢失率从 0.62% (  $W$  =30) 压低至 0.53% (  $W$  =60)，系统延迟增加了约 **18 分钟** (50.5 → 68.4 min)。
        - **滑动窗口**：为了捕获最后 0.5% 的数据，系统延迟更是飙升至 **75.55 分钟**。
    - **趋势特征**：红色折线（延迟）陡峭上升，而蓝色柱子（丢失率）的下降幅度极小，呈现出显著的**边际收益递减**。
    - 分析：这是为了捕获极少量“长尾数据”所必须付出的高昂代价。基于当前场景评估，这种交换通常是不划算的。

***2.3 结论：最佳收益点***

实验数据显示出明显的最佳收益点。在当前实验场景下，我们认为水位线设置为**10分钟**是**平衡效率与性能的最佳点**；而在对准确率有极端要求的特定需求下，可进一步放宽至**60分钟**以获取最大收益。

### 三、“平台期”现象与数据流跳变

***3.1 现象观察：非线性的边际效益***

在分析水位线参数  $W$  与系统性能的关系时（见*图 2-1* 和*图 3-1*），我们观测到两个现象。首先，当水位线从 10 分钟增加至 23 分钟时，理论上应当能覆盖更宽的乱序窗口，但实际上数据丢失率维持在 1.83% 左右几乎停滞不前，系统并未挽回更多有效数据。其次，当水位线从 10 分钟增加至 23 分钟时，窗口延迟也几乎没有变化（在原本的假设中，窗口延迟与水位线延迟设置应该为完全的线性关系）。

![Figure_3_1.png](/pic/Figure_3_1.png)

*图 3-1：区间“挽回”数据量分布图*

***3.2 假设排查：数据分布的连续性验证***

最初，我们推测该现象可能源于**数据稀疏性**，即原始数据集中可能恰好缺乏迟到时长分布在 $[10, 23]$ 分钟区间的记录。为了验证该假设，我们绘制了“数据延迟分布图”（*图 3-2*）。统计结果显示，迟到数据的到达时间呈现连续且均匀的分布特征，并不存在特定时间段的数据断层，因此排除“数据缺失”导致平台期的假设。

![Figure_1.png](/pic/Figure_1.png)

*图 3-2：数据到达延迟分布*

![Figure_1.png](/pic/Figure_1%201.png)

*图 3-3：数据到达延迟分布（仅统计跨小时延迟）*

**3.3 水位线的离散变化**

经过对 Flink 水位线机制的分析，我们认为该现象的根本原因在于**数据流时间戳推进的非连续性**。Flink 的事件时间窗口触发遵循以下核心逻辑：

- **水位线生成公式**： $Watermark = \text{MaxSeenTimestamp} - \text{DelayParam}$ 
- **窗口触发条件**： $Watermark \ge \text{WindowEndTime}$ 

将两式联立，可得窗口被关闭的临界条件：

$$
\text{MaxSeenTimestamp} - \text{DelayParam} \ge \text{WindowEndTime}
$$

我们统计了数据流跨越小时边界时的“跳变幅度”，如*图 3-3*所示。这张直方图展示的是：**当数据流的时间戳第一次跨入新的一小时窗口（例如从 12点变到 13点）时，它跳过了多少分钟**横轴是新的一小时窗口中首条数据的分钟数，纵轴代表频次。从*图 3-4*中可以看到，大部分数据都处在0-5分钟之间。从*图 3-5*中可以看到，即使有很多小时的第一条数据的时间为10-60分钟之间，但它们所影响的乱序数据量很少。因此，水位线延迟在10分钟之后所带来的准确率收益提升很有限。

![Figure_1.png](/pic/Figure_1%202.png)

*图 3-4：每小时窗口首个时间戳分钟数分布图*

![Figure_1.png](/pic/Figure_1%203.png)

*图 3-5：滚动窗口时间戳分钟数及影响力柱状图（影响力=在该时间戳之后，该时间戳减水位线延迟大于对应窗口结束时间的数据量）*

![Figure_1.png](/pic/Figure_1%204.png)

*图 3-6：滑动窗口时间戳分钟数及影响力柱状图（影响力=在该时间戳之后，该时间戳减水位线延迟大于对应窗口结束时间的数据量）*

***3.4 结论***

水位线推进的粒度取决于数据流中新窗口第一个到达的时间戳的**跳变幅度**与**影响数据量**。在处理非连续或稀疏上报的数据流（如批量上传日志）时，水位线参数的设置可能不应该过多参考平均迟到时间，而是**考虑如何覆盖“数据流的绝大部分时间跳变阈值”**。在本例中，10分钟的水位线延迟已经能够覆盖绝大部分的迟到数据。

### 四、窗口模式对比：滚动窗口 (Tumbling) vs 滑动窗口 (Sliding)

本节基于实验数据，对比分析了**滚动窗口**（Size=60m）与**滑动窗口**（Size=60m, Step=30m）在不同水位线延迟下的表现差异，探究在同一业务场景下，窗口的改变对“实时性-准确性”权衡曲线的影响。

![image.png](/pic/image%209.png)

*图 4-1：滚动窗口与滑动窗口的平均系统延迟对比*

![image.png](/pic/image%2010.png)

*图 4-2：滚动窗口与滑动窗口的全局误差对比*

![image.png](/pic/image%2011.png)

*图 4-3：滚动窗口与滑动窗口的统计拟合度 (* $R^2$ *Score) 对比*

***4.1 分析与结论***

通过分析水位线延迟为0时滑动窗口与滚动窗口的窗口延迟与数据丢失率可知，在水位线延迟为0时，滑动窗口的数据丢失率仅为40.7%，而滚动窗口达到79.5%。因此滑动窗口的窗口延迟相对较高。

通过分析*图 3-5*与*图 3-6*可得，在滑动窗口（半小时步长，一小时窗口）下，一部分数据需要使用接近一小时的水位线延迟才能够不丢失。因此从结果来看，在10-50min水位线延迟区间上，滑动窗口的数据获取率、金额准确率均要低于滚动窗口，而窗口延迟要高于滚动窗口。

需要注意的是，我们的滑动窗口与滚动窗口是两种不同的任务。**因此本实验并非通过对比来判断两者的优劣**，而是通过两者不同的表现来展示**在同一大负载下，任务特性不同（例如窗口类型、窗口大小）对水位线延迟的设置策略也会有影响。**

## **结论**

- **水位线设置策略与负载设计、窗口类型（大小）、数据分布强相关**
    - 对负载数据原始分布的分析（*图 3-5*与*图 3-6*）能够很好的解释（或预测）在不同水位线设置下，窗口延迟大小与数据丢失率的变化。
    - 因此在运行实际 Flink 作业时，如条件允许，建议对目标任务进行预实验并采样分析数据分布，再结合本研究方法制定合适的水位线策略。
- **窗口延迟与数据准确率相互制约**
    - 在本实验中发现：**若提高水位线延迟能够显著提升数据准确率，则必然伴随窗口延迟的上升；反之，若数据准确率变化不大，窗口延迟也不会因此增加（即便水位线延迟被大幅提高）。**
    - 究其原因，这是因为**如果在某一水位线延迟范围内，该延迟设定几乎不会影响延迟数据，那么窗口延迟与数据丢失率均不会发生变化。**
        - 例如：
        
        窗口为1:00-2:00, 2:00-3:00。数据流为[ ( 1, 1:10 ), ( 2, 1:20 ), ( 3, 2:20 ), ( 4, 1:30 ), ( 5, 2:30 ) ]
        
        将水位线设置为0-20之间，则在处理 数据( 3, 2:20 )时，窗口1:00-2:00便会触发，从而抛弃数据( 4, 1:30 )。因此，将水位线从0提升直至20都无法对窗口延迟和数据丢失率产生影响，因为 ( 4, 1:30 )一直是丢失状态，而延迟一直是2:20-2:00=20。
        
        只有当水位线提升至21时，触发1:00-2:00窗口处理的水位线数据才会从( 3, 2:20 )变为 ( 5, 2:30 )，此时窗口延迟为2:30-2:00=30，且 ( 4, 1:30 )不被丢失。
        
- **最佳水位线设置**
    - 在本实验场景下，**水位线  $W$  = 10** 最佳，能以较小的延迟代价保障较好的数据完整性。仅在对准确率有极端要求的长尾场景下，建议将水位线放宽至  $W$  **= 60** 以作为备选方案。

## **分工**

谢瑞阳：负责 Flink 分布式集群的底层环境配置与调试，选取实验工作负载、获取数据集并完成数据清洗与预处理脚本编写，进行单机环境下的初步测试，负责实验任务规划与分配、实验日志的记录与原始数据的收集整理，以及实验报告的润色。

章涵：负责初步搭建Flink乱序实验负载，撰写实验环境、负载描述、详细实验步骤及衡量指标定义等章节，参与分布式集群下的多参数对照实验，负责实验原始数据的收集整理，制作项目展示视频，并负责所有提交材料的最终汇总与打包。

陈婧：主导“实验结果与分析”部分的撰写，协同完成分布式环境下的实验操作与监控，负责实验数据的后处理与图表生成，以及汇报 PPT 的制作。

常苗韦：协同撰写“实验结果与分析”部分，协同完成分布式环境下的实验操作与监控，负责实验关键指标的统计分析，以及汇报 PPT 的制作。